name: Windows RDP via Ngrok (Max Specs Available)

on: [push]

jobs:
  rdp-setup:
    # ÙŠØ³ØªØ®Ø¯Ù… Ø£Ù‚ØµÙ‰ Ù…ÙˆØ§ØµÙØ§Øª Ù…Ø¬Ø§Ù†ÙŠØ© Ù…ØªØ§Ø­Ø© (Windows Server 2022)
    runs-on: windows-latest 
    timeout-minutes: 360  # 6 Ø³Ø§Ø¹Ø§Øª ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰

    steps:
    - name: Download and extract Ngrok
      run: |
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… PowerShell
        Invoke-WebRequest "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip" -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath .
        Remove-Item ngrok.zip -Force

    - name: Authenticate Ngrok
      run: .\ngrok.exe authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Enable Remote Desktop
      run: |
        # ØªÙØ¹ÙŠÙ„ RDP ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø­Ù…Ø§ÙŠØ©
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        New-NetFirewallRule -DisplayName "Allow RDP via Ngrok" -Direction Inbound -Action Allow -Protocol TCP -LocalPort 3389

    - name: Create RDP User
      run: |
        # ğŸ”‘ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚ÙˆÙŠØ© Ø§Ù„ØªÙŠ Ù†Ø¬Ø­Øª Ø³Ø§Ø¨Ù‚Ø§Ù‹
        net user kamel007 KmlRDP-2025! /add /Y
        net localgroup administrators kamel007 /add
        # Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v kamel007 /t REG_DWORD /d 0 /f

    - name: Start Ngrok and display connection info
      run: |
        # Ø¨Ø¯Ø¡ Ngrok ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        Start-Process -FilePath "$pwd\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout" -NoNewWindow -RedirectStandardOutput ngrok.log
        
        $timeout = 60
        $tunnelUrl = $null
        
        while ($timeout -gt 0 -and -not $tunnelUrl) {
          Start-Sleep -Seconds 5
          $timeout -= 5
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙÙ‚ Ø¹Ø¨Ø± API
          try {
            $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction Stop
            $tunnelUrl = $response.tunnels[0].public_url -replace "tcp://", ""
          } catch {
            # Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¥Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„
            $logContent = Get-Content ngrok.log -ErrorAction SilentlyContinue
            $tunnelUrl = $logContent | Select-String -Pattern "tcp://([a-zA-Z0-9\.\-]+:\d+)" | ForEach-Object { $_.Matches.Groups[1].Value }
          }
        }

        if (-not $tunnelUrl) {
          Write-Output "::error::Failed to establish Ngrok tunnel after 60 seconds"
          exit 1
        }

        Write-Output "=========================================="
        Write-Output "||        RDP CONNECTION DETAILS        ||"
        Write-Output "=========================================="
        Write-Output "Address: $tunnelUrl"
        Write-Output "Username: kamel007"
        Write-Output "Password: KmlRDP-2025!" # âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚ÙˆÙŠØ©
        Write-Output "------------------------------------------"
        Write-Output "1. Open Remote Desktop (mstsc)"
        Write-Output "2. Connect to: $tunnelUrl"
        Write-Output "=========================================="

        # Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù€ Job Ø­ÙŠØ§Ù‹
        while ($true) { Start-Sleep -Seconds 300 }

    - name: Force cleanup
      if: always()
      run: |
        Stop-Process -Name "ngrok" -Force -ErrorAction SilentlyContinue
        Stop-Process -Name "mstsc" -Force -ErrorAction SilentlyContinue
